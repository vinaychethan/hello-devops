name: CI-CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  ci-cd:
    runs-on: self-hosted

    steps:
      # =========================
      # Build
      # =========================
      - name: Build
        uses: actions/checkout@v4

      # =========================
      # Test
      # =========================
      - name: Test
        run: |
          echo "Running basic validation"
          test -f Dockerfile
          test -d k8s
          echo "Tests passed"

      # =========================
      # Docker
      # =========================
      - name: Docker
        run: |
          docker build -t hello-devops:latest .

      # =========================
      # Deploy
      # =========================
      - name: Deploy
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/hello-devops

name: CI-CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Build stage"
          test -f Dockerfile

  test:
    name: Test
    runs-on: self-hosted
    needs: build
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Test stage"
          test -d k8s
          echo "Tests passed"

  docker:
    name: Docker
    runs-on: self-hosted
    needs: test
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Docker stage"
          docker build -t hello-devops:latest .

  deploy:
    name: Deploy
    runs-on: self-hosted
    needs: docker
    steps:
      - uses: actions/checkout@v4
      - run: |
          echo "Deploy stage"
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/hello-devops
